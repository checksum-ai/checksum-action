name: 'Checksum CI Guard'
description: 'AI-powered code review for pull requests'
author: 'Checksum AI'

branding:
  icon: 'shield'
  color: 'blue'

inputs:
  checksum_api_key:
    description: 'Your Checksum API key'
    required: true
  pr_number:
    description: 'Pull request number'
    required: true
  pr_title:
    description: 'Pull request title'
    required: true
  pr_url:
    description: 'Pull request URL'
    required: true
  base_sha:
    description: 'Base commit SHA'
    required: true
  head_sha:
    description: 'Head commit SHA'
    required: true
  pr_body:
    description: 'Pull request body/description'
    required: false
    default: ''
  extra_context:
    description: 'Additional context to provide to the reviewer (optional)'
    required: false
    default: ''

runs:
  using: 'composite'
  steps:
    - name: Install ripgrep
      shell: bash
      run: |
        if ! command -v rg &> /dev/null; then
          sudo apt-get update && sudo apt-get install -y ripgrep
        fi

    - name: Authenticate with Checksum
      id: auth
      shell: bash
      env:
        CHECKSUM_API_KEY: ${{ inputs.checksum_api_key }}
      run: |
        HTTP_RESPONSE=$(curl -sS -w "\n%{http_code}" -X POST \
          "https://aiagents.checksum.ai/agent-services/github-auth-token" \
          -H "x-api-key: $CHECKSUM_API_KEY")

        HTTP_CODE=$(echo "$HTTP_RESPONSE" | tail -n1)
        RESPONSE=$(echo "$HTTP_RESPONSE" | sed '$d')

        if [ "$HTTP_CODE" != "200" ]; then
          echo "::error::Failed to authenticate with Checksum API (HTTP $HTTP_CODE)"
          exit 1
        fi

        GITHUB_TOKEN=$(echo "$RESPONSE" | jq -r '.github_token')
        if [ "$GITHUB_TOKEN" = "null" ] || [ -z "$GITHUB_TOKEN" ]; then
          echo "::error::Failed to get GitHub token from response"
          exit 1
        fi

        echo "github_token=$GITHUB_TOKEN" >> $GITHUB_OUTPUT

    - name: Install CI Guard Agent
      shell: bash
      run: |
        curl -fsSL "https://storage.googleapis.com/checksum-agent-public/install.sh?$(date +%s)" | bash -s -- --pr-review

    - name: Run CI Guard
      shell: bash
      env:
        GITHUB_TOKEN: ${{ steps.auth.outputs.github_token }}
        CHECKSUM_API_KEY: ${{ inputs.checksum_api_key }}
        PR_BODY: ${{ inputs.pr_body }}
        EXTRA_CONTEXT: ${{ inputs.extra_context }}
      run: |
        # Capture diff with file-level truncation
        capture_truncated_diff() {
          local BASE_SHA="$1"
          local HEAD_SHA="$2"
          local MAX_TOTAL=100000
          local MAX_PER_FILE=10000

          # Get list of changed files
          local CHANGED_FILES=$(git diff --name-only "$BASE_SHA".."$HEAD_SHA")

          if [ -z "$CHANGED_FILES" ]; then
            echo "No changes detected."
            return
          fi

          local FILE_COUNT=$(echo "$CHANGED_FILES" | wc -l | tr -d ' ')

          # Calculate per-file budget (divide total by file count, capped at MAX_PER_FILE)
          local PER_FILE_BUDGET=$((MAX_TOTAL / FILE_COUNT))
          [ "$PER_FILE_BUDGET" -gt "$MAX_PER_FILE" ] && PER_FILE_BUDGET=$MAX_PER_FILE

          # Output file list with stats
          echo "Changed files ($FILE_COUNT):"
          git diff --stat "$BASE_SHA".."$HEAD_SHA" | head -50
          echo ""
          echo "---"
          echo ""

          # Build truncated diff
          echo "$CHANGED_FILES" | while read -r FILE; do
            [ -z "$FILE" ] && continue

            local FILE_DIFF=$(git diff "$BASE_SHA".."$HEAD_SHA" -- "$FILE")
            local ACTUAL_SIZE=${#FILE_DIFF}

            if [ "$ACTUAL_SIZE" -gt "$PER_FILE_BUDGET" ]; then
              echo "${FILE_DIFF:0:$PER_FILE_BUDGET}"
              echo ""
              echo "... [${FILE} truncated: showing $PER_FILE_BUDGET of $ACTUAL_SIZE bytes. Use 'git diff $BASE_SHA..$HEAD_SHA -- \"$FILE\"' for full diff]"
              echo ""
            else
              echo "$FILE_DIFF"
            fi
          done
        }

        # Capture the diff
        DIFF_OUTPUT=$(capture_truncated_diff "${{ inputs.base_sha }}" "${{ inputs.head_sha }}")

        PROMPT="You are reviewing a GitHub Pull Request.

        Review PR #${{ inputs.pr_number }} in ${{ github.repository }}.

        PR Title: ${{ inputs.pr_title }}
        PR URL: ${{ inputs.pr_url }}
        Base SHA: ${{ inputs.base_sha }}
        Head SHA: ${{ inputs.head_sha }}

        PR Description:
        $PR_BODY

        ## Changes

        $DIFF_OUTPUT

        ---
        Note: Large diffs may be truncated per-file. Use 'git diff' or 'git show' for full content if needed.

        Use 'gh pr comment ${{ inputs.pr_number }} --body-file <file>' to post comments."

        if [ -n "$EXTRA_CONTEXT" ]; then
          PROMPT="$PROMPT

        Additional Context:
        $EXTRA_CONTEXT"
        fi

        ~/.checksumai/callagents.sh pull-request-tester "$PROMPT"
